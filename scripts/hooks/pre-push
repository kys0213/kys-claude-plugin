#!/bin/bash
# pre-push hook: CI(validate.yml)와 동일한 Rust 검증 체인 실행
# Cargo.toml이 존재하는 모든 Rust 프로젝트를 무조건 검증
#
# CI 검증 순서:
#   1. cargo fmt --check
#   2. cargo clippy -- -D warnings
#   3. cargo check
#   4. cargo test

set -e

RUST_DIRS=(
  "plugins/autodev/cli"
  "plugins/suggest-workflow/cli"
)

for dir in "${RUST_DIRS[@]}"; do
  if [ ! -f "$dir/Cargo.toml" ]; then
    continue
  fi

  echo "══════════════════════════════════════════"
  echo "  pre-push: validating $dir"
  echo "══════════════════════════════════════════"

  # 1. Format check
  echo "→ cargo fmt --check"
  if ! (cd "$dir" && cargo fmt --check 2>&1); then
    echo ""
    echo "✗ cargo fmt --check failed in $dir"
    echo "  Run: cd $dir && cargo fmt"
    exit 1
  fi

  # 2. Clippy lint
  echo "→ cargo clippy -- -D warnings"
  if ! (cd "$dir" && cargo clippy -- -D warnings 2>&1); then
    echo ""
    echo "✗ cargo clippy failed in $dir"
    exit 1
  fi

  # 3. Type check
  echo "→ cargo check"
  if ! (cd "$dir" && cargo check 2>&1); then
    echo ""
    echo "✗ cargo check failed in $dir"
    exit 1
  fi

  # 4. Tests
  echo "→ cargo test"
  if ! (cd "$dir" && cargo test 2>&1); then
    echo ""
    echo "✗ cargo test failed in $dir"
    exit 1
  fi

  echo "✓ $dir passed all checks"
  echo ""
done

exit 0
