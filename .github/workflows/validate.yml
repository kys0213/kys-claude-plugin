name: Validate Plugin

on:
  pull_request:
    branches: [main]
    paths:
      - 'plugins/**'
      - '.claude-plugin/**'
      - 'common/**'
      - 'tools/**'

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache-dependency-path: tools/validate/go.sum

      - name: Build validate tool
        run: make build

      - name: Run tests
        run: make test

      - name: Run plugin validation
        run: make validate-ci

      - name: Check for Rust plugin changes
        id: check_rust
        run: |
          CHANGED=$(git diff --name-only origin/main...HEAD)
          if echo "$CHANGED" | grep -q '^plugins/suggest-workflow/'; then
            echo "sw_changed=true" >> $GITHUB_OUTPUT
          else
            echo "sw_changed=false" >> $GITHUB_OUTPUT
          fi
          if echo "$CHANGED" | grep -q '^plugins/autodev/'; then
            echo "autodev_changed=true" >> $GITHUB_OUTPUT
          else
            echo "autodev_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Rust
        if: steps.check_rust.outputs.sw_changed == 'true' || steps.check_rust.outputs.autodev_changed == 'true'
        uses: actions-rust-lang/setup-rust-toolchain@v1

      # ── suggest-workflow checks ──
      - name: suggest-workflow fmt check
        if: steps.check_rust.outputs.sw_changed == 'true'
        working-directory: plugins/suggest-workflow/cli
        run: cargo fmt --check

      - name: suggest-workflow clippy
        if: steps.check_rust.outputs.sw_changed == 'true'
        working-directory: plugins/suggest-workflow/cli
        run: cargo clippy -- -D warnings

      - name: suggest-workflow check and test
        if: steps.check_rust.outputs.sw_changed == 'true'
        working-directory: plugins/suggest-workflow/cli
        run: |
          cargo check
          cargo test

      # ── autodev checks ──
      - name: autodev fmt check
        if: steps.check_rust.outputs.autodev_changed == 'true'
        working-directory: plugins/autodev/cli
        run: cargo fmt --check

      - name: autodev clippy
        if: steps.check_rust.outputs.autodev_changed == 'true'
        working-directory: plugins/autodev/cli
        run: cargo clippy -- -D warnings

      - name: autodev check and test
        if: steps.check_rust.outputs.autodev_changed == 'true'
        working-directory: plugins/autodev/cli
        run: |
          cargo check
          cargo test

      - name: Check PR title format
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          echo "PR Title: $PR_TITLE"

          # Conventional Commits 형식 검증
          if ! echo "$PR_TITLE" | grep -qE '^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert|major)(\(.+\))?: .+'; then
            echo "::error::PR title must follow Conventional Commits format"
            echo ""
            echo "Expected format: type(scope): description"
            echo "Valid types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert, major"
            echo ""
            echo "Examples:"
            echo "  feat: add new review command"
            echo "  fix(review): correct path resolution"
            echo "  major: breaking API changes"
            exit 1
          fi

          echo "✓ PR title format is valid"

      - name: Check version bump prefix for code changes
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # plugins 또는 common 디렉토리에 변경이 있는지 확인
          CHANGED_FILES=$(gh pr view ${{ github.event.pull_request.number }} --json files -q '.files[].path')

          HAS_CODE_CHANGES=false
          if echo "$CHANGED_FILES" | grep -qE '^(plugins/|common/)'; then
            HAS_CODE_CHANGES=true
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"
          echo ""
          echo "Has code changes in plugins/ or common/: $HAS_CODE_CHANGES"

          if [ "$HAS_CODE_CHANGES" = "true" ]; then
            # 버전업을 트리거하는 prefix인지 확인 (feat, fix, refactor, major)
            if ! echo "$PR_TITLE" | grep -qE '^(feat|fix|refactor|major|docs)(\(.+\))?:'; then
              echo ""
              echo "::error::Code changes in plugins/ or common/ require a version bump prefix"
              echo ""
              echo "Your PR title: $PR_TITLE"
              echo ""
              echo "Version bump prefixes:"
              echo "  major: breaking changes (bumps major version)"
              echo "  feat:  new features (bumps minor version)"
              echo "  fix:   bug fixes (bumps patch version)"
              echo "  refactor: code refactoring (bumps patch version)"
              echo "  docs:  documentation changes (no version bump)"
              echo ""
              echo "Non-version prefixes (style, test, ci, chore, etc.) are only"
              echo "allowed for changes that don't affect plugins/ or common/ directories."
              exit 1
            fi
            echo "✓ Version bump prefix is valid for code changes"
          else
            echo "✓ No code changes in plugins/ or common/, any prefix is allowed"
          fi
