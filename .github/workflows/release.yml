name: Auto Version Bump

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  version-bump:
    runs-on: ubuntu-latest
    # version bump 커밋은 다시 트리거하지 않음
    if: "!contains(github.event.head_commit.message, '[skip ci]')"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Build bumpversion tool
        run: |
          cd tools/bumpversion
          go build -o ../../bumpversion .

      - name: Get commit info and determine bump type
        id: bump_info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 마지막 커밋 메시지에서 PR 번호 추출
          COMMIT_MSG=$(git log -1 --format=%s)
          echo "Commit message: $COMMIT_MSG"

          PR_NUMBER=$(echo "$COMMIT_MSG" | grep -oE '#[0-9]+' | tr -d '#' | head -1)

          if [ -n "$PR_NUMBER" ]; then
            echo "Found PR #$PR_NUMBER"
            PR_TITLE=$(gh pr view "$PR_NUMBER" --json title -q '.title' 2>/dev/null || echo "")
          else
            PR_TITLE="$COMMIT_MSG"
          fi

          echo "PR Title: $PR_TITLE"

          # bump 타입 결정
          if echo "$PR_TITLE" | grep -qE '^major(\(.+\))?:'; then
            BUMP_TYPE="major"
          elif echo "$PR_TITLE" | grep -qE '^feat(\(.+\))?:'; then
            BUMP_TYPE="minor"
          elif echo "$PR_TITLE" | grep -qE '^(fix|refactor)(\(.+\))?:'; then
            BUMP_TYPE="patch"
          else
            BUMP_TYPE="none"
          fi

          echo "Bump type: $BUMP_TYPE"
          echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT
          echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT

      - name: Bump versions
        if: steps.bump_info.outputs.bump_type != 'none'
        run: |
          BUMP_TYPE="${{ steps.bump_info.outputs.bump_type }}"
          PR_TITLE="${{ steps.bump_info.outputs.pr_title }}"

          echo "Bumping version: $BUMP_TYPE"
          echo "PR Title: $PR_TITLE"

          # 변경된 플러그인만 버전 범프 (Go 도구 사용)
          # main 브랜치의 이전 커밋과 비교하여 변경된 플러그인 감지
          ./bumpversion --base=HEAD~1 --type="$BUMP_TYPE" --verbose

          # marketplace.json에서 가장 높은 버전을 새 버전으로 사용
          NEW_VERSION=$(jq -r '[.plugins[].version] | max' .claude-plugin/marketplace.json)
          echo "New version: $NEW_VERSION"
          echo "$NEW_VERSION" > .new_version

      - name: Commit and push version bump
        if: steps.bump_info.outputs.bump_type != 'none'
        run: |
          NEW_VERSION=$(cat .new_version)

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A
          git commit -m "chore: bump version to $NEW_VERSION [skip ci]" || echo "No changes to commit"
          git push

      - name: Verify version consistency
        if: steps.bump_info.outputs.bump_type != 'none'
        run: |
          echo "Verifying version consistency after bump..."
          cd tools/validate && go build -o ../../validate .
          cd ../..
          ./validate --versions-only . || {
            echo "::error::Version consistency check failed after bump"
            exit 1
          }

      - name: Create release tag
        if: steps.bump_info.outputs.bump_type != 'none'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NEW_VERSION=$(cat .new_version)

          git tag "v$NEW_VERSION"
          git push origin "v$NEW_VERSION"

          gh release create "v$NEW_VERSION" \
            --title "Release v$NEW_VERSION" \
            --generate-notes

          echo "✓ Created release v$NEW_VERSION"
