name: Auto Version Bump

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  version-bump:
    runs-on: ubuntu-latest
    # version bump 커밋은 다시 트리거하지 않음
    if: "!contains(github.event.head_commit.message, '[skip ci]')"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Build bumpversion tool
        run: |
          cd tools/bumpversion
          go build -o ../../bumpversion .

      - name: Get commit info and determine bump type
        id: bump_info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 마지막 커밋 메시지에서 PR 번호 추출
          COMMIT_MSG=$(git log -1 --format=%s)
          echo "Commit message: $COMMIT_MSG"

          PR_NUMBER=$(echo "$COMMIT_MSG" | grep -oE '#[0-9]+' | tr -d '#' | head -1)

          if [ -n "$PR_NUMBER" ]; then
            echo "Found PR #$PR_NUMBER"
            PR_TITLE=$(gh pr view "$PR_NUMBER" --json title -q '.title' 2>/dev/null || echo "")
          else
            PR_TITLE="$COMMIT_MSG"
          fi

          echo "PR Title: $PR_TITLE"

          # bump 타입 결정
          if echo "$PR_TITLE" | grep -qE '^major(\(.+\))?:'; then
            BUMP_TYPE="major"
          elif echo "$PR_TITLE" | grep -qE '^feat(\(.+\))?:'; then
            BUMP_TYPE="minor"
          elif echo "$PR_TITLE" | grep -qE '^(fix|refactor)(\(.+\))?:'; then
            BUMP_TYPE="patch"
          else
            BUMP_TYPE="none"
          fi

          echo "Bump type: $BUMP_TYPE"
          echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT
          echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT

      - name: Bump versions
        id: bump_versions
        if: steps.bump_info.outputs.bump_type != 'none'
        run: |
          BUMP_TYPE="${{ steps.bump_info.outputs.bump_type }}"
          PR_TITLE="${{ steps.bump_info.outputs.pr_title }}"

          echo "Bumping version: $BUMP_TYPE"
          echo "PR Title: $PR_TITLE"

          # 변경된 플러그인만 버전 범프 (Go 도구 사용, JSON 출력)
          # main 브랜치의 이전 커밋과 비교하여 변경된 플러그인 감지
          BUMP_RESULT=$(./bumpversion --base=HEAD~1 --type="$BUMP_TYPE" --json)
          echo "Bump result: $BUMP_RESULT"

          # 범프된 플러그인 목록 저장 (플러그인별 태그 생성용)
          echo "$BUMP_RESULT" > .bump_result.json

      - name: Verify version consistency
        if: steps.bump_info.outputs.bump_type != 'none'
        run: |
          echo "Verifying version consistency before push..."
          make build
          make validate-versions || {
            echo "::error::Version consistency check failed after bump"
            exit 1
          }

      - name: Commit and push version bump
        if: steps.bump_info.outputs.bump_type != 'none'
        run: |
          # 범프된 플러그인 요약 생성
          SUMMARY=$(jq -r '.results[] | "\(.plugin) \(.old_version) → \(.new_version)"' .bump_result.json | paste -sd ', ' -)

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A
          git commit -m "chore: bump versions ($SUMMARY) [skip ci]" || echo "No changes to commit"
          git push

      - name: Create release tags
        if: steps.bump_info.outputs.bump_type != 'none'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 범프된 플러그인별로 개별 태그 및 릴리즈 생성
          jq -c '.results[]' .bump_result.json | while read -r item; do
            PLUGIN=$(echo "$item" | jq -r '.plugin')
            VERSION=$(echo "$item" | jq -r '.new_version')
            TAG="${PLUGIN}/v${VERSION}"

            echo "Creating tag: $TAG"
            git tag "$TAG"
            git push origin "$TAG"

            gh release create "$TAG" \
              --title "${PLUGIN} v${VERSION}" \
              --generate-notes

            echo "✓ Created release ${PLUGIN} v${VERSION}"
          done
