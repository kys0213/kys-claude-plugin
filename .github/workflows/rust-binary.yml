name: Build Rust Binaries

on:
  workflow_run:
    workflows: ["Auto Version Bump"]
    types: [completed]

permissions:
  contents: write

jobs:
  detect:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}
      has_builds: ${{ steps.matrix.outputs.has_builds }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          fetch-depth: 0

      - name: Detect Rust plugins to build
        id: matrix
        run: |
          python3 << 'PYEOF'
          import tomllib, json, subprocess, os

          # 범프 커밋에 달린 태그에서 플러그인 이름 추출
          raw = subprocess.check_output(["git", "tag", "--points-at", "HEAD"]).decode().strip()
          tags = [t for t in raw.split("\n") if t and "/v" in t]

          includes = []
          for tag in tags:
              plugin = tag.rsplit("/v", 1)[0]
              cargo_path = f"plugins/{plugin}/cli/Cargo.toml"

              if not os.path.isfile(cargo_path):
                  print(f"Skip {plugin}: no {cargo_path}")
                  continue

              with open(cargo_path, "rb") as f:
                  data = tomllib.load(f)

              ci = data.get("package", {}).get("metadata", {}).get("ci", {})
              targets = ci.get("targets", [])
              if not targets:
                  print(f"Skip {plugin}: no ci.targets in Cargo.toml")
                  continue

              features = ",".join(ci.get("features", []))
              binary = data.get("bin", [{}])[0].get("name", plugin) if data.get("bin") else data.get("package", {}).get("name", plugin)

              for target in targets:
                  suffix = target["artifact-suffix"]
                  includes.append({
                      "plugin": plugin,
                      "tag": tag,
                      "os": target["os"],
                      "features": features,
                      "binary": binary,
                      "artifact": f"{plugin}-{suffix}",
                  })

          matrix = json.dumps({"include": includes})
          has_builds = "true" if includes else "false"

          print(f"Matrix: {matrix}")
          print(f"Has builds: {has_builds}")

          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"matrix={matrix}\n")
              f.write(f"has_builds={has_builds}\n")
          PYEOF

  build:
    needs: detect
    if: ${{ needs.detect.outputs.has_builds == 'true' }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect.outputs.matrix) }}
    runs-on: ${{ matrix.os }}
    name: Build ${{ matrix.artifact }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          fetch-depth: 0

      - name: Setup Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Build release binary
        working-directory: plugins/${{ matrix.plugin }}/cli
        run: |
          if [ -n "${{ matrix.features }}" ]; then
            cargo build --release --features "${{ matrix.features }}"
          else
            cargo build --release
          fi

      - name: Package binary
        run: |
          cd plugins/${{ matrix.plugin }}/cli/target/release
          tar czf ${{ github.workspace }}/${{ matrix.artifact }}.tar.gz ${{ matrix.binary }}

      - name: Upload to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload ${{ matrix.tag }} ${{ matrix.artifact }}.tar.gz --clobber
