---
description: git-workflow 플러그인 초기 설정. GitHub 환경, Default Branch Guard hook 등을 사용자/프로젝트 단위로 설정합니다.
allowed-tools:
  - Read
  - Bash
  - Write
  - AskUserQuestion
---

# Git Workflow Setup

이 커맨드는 git-workflow 플러그인을 설정합니다. HITL(Human-in-the-Loop)로 기능과 설치 범위를 선택합니다.

## Step 1: 환경 확인

먼저 git 저장소인지 확인합니다:

```bash
git rev-parse --is-inside-work-tree 2>/dev/null
```

**git 저장소가 아닌 경우:**

```
이 디렉토리는 git 저장소가 아닙니다.
git-workflow는 git 저장소에서만 동작합니다.

먼저 git init을 실행하거나, git 저장소 디렉토리에서 다시 실행해주세요.
```

→ 설정을 중단합니다.

**git 저장소인 경우**, 기본 브랜치를 감지합니다:

```bash
git symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's|refs/remotes/origin/||' || echo 'main'
```

기존 환경 파일도 확인합니다:

```bash
cat ~/.git-workflow-env 2>/dev/null
```

## Step 2: 기능 선택

AskUserQuestion (multiSelect: true)으로 설정할 기능을 선택받습니다:

```
git-workflow를 설정합니다.
어떤 기능을 설정하시겠습니까? (복수 선택 가능)
```

옵션:
1. **GitHub 환경 설정** - GH_HOST, 인증 등 gh CLI 환경변수 (Enterprise 사용 시 필수)
2. **Default Branch Guard** - 기본 브랜치에서 파일 수정/커밋 시도 시 즉시 차단 (PreToolUse)
3. **모두 설정 (Recommended)** - 위 항목 모두 설정

> 향후 추가 기능(예: pre-push 검증 등)이 이 단계에서 선택지로 추가됩니다.

선택에 따라 해당 섹션만 실행합니다:
- GitHub 환경 설정 → Step 3으로
- Default Branch Guard → Step 4로
- 모두 설정 → Step 3 → Step 4 순서로

---

## Step 3: GitHub 환경 설정

### 3-1: GitHub 호스트 확인

AskUserQuestion으로 GitHub 환경을 확인합니다:

```
GitHub 환경을 선택하세요.
```

옵션:
1. **github.com (Recommended)** - 기본 GitHub
2. **GitHub Enterprise** - 자체 호스팅 GitHub (별도 호스트네임)

### 3-2: Enterprise 선택 시 호스트 입력

AskUserQuestion (Other로 직접 입력):

```
GitHub Enterprise 호스트네임을 입력하세요.
(예: github.mycompany.com)
```

### 3-3: 인증 상태 확인

```bash
# github.com인 경우
gh auth status 2>&1

# Enterprise인 경우
gh auth status --hostname {gh_host} 2>&1
```

**인증 안 된 경우:**

```
GitHub 인증이 필요합니다.
다음 명령어로 로그인해주세요:

  gh auth login --hostname {gh_host}

로그인 후 /setup을 다시 실행하세요.
```

→ 설정을 중단합니다. (인증 없이는 gh 명령어가 동작하지 않으므로)

**인증 된 경우**, `~/.git-workflow-env` 파일을 생성합니다.

### 3-4: 환경 파일 생성

```bash
cat > ~/.git-workflow-env << 'ENV'
# git-workflow 환경 설정
# Generated by /setup
# Re-run /setup to modify

# GitHub host (비어있으면 github.com)
export GH_HOST="{gh_host_or_empty}"
ENV

chmod 600 ~/.git-workflow-env
```

- github.com 선택 시: `GH_HOST=""` (비어있으면 gh CLI가 기본값 사용)
- Enterprise 선택 시: `GH_HOST="github.mycompany.com"`

### 3-5: GitHub 설정 완료 메시지

```
GitHub 환경이 설정되었습니다!

생성된 파일:
└─ ~/.git-workflow-env

설정 내용:
├─ Host: {gh_host or "github.com (기본값)"}
└─ 인증: 확인됨

모든 gh 스크립트가 이 설정을 자동으로 로드합니다.
```

---

## Step 4: Default Branch Guard 설치 범위 선택

AskUserQuestion으로 설치 범위를 선택받습니다:

```
hook 설치 범위를 선택하세요.
```

옵션:
1. **프로젝트 (Recommended)** - 이 프로젝트에만 적용 (.claude/settings.json). 팀과 공유 가능
2. **사용자** - 모든 프로젝트에 적용 (~/.claude/settings.json). 개인 설정

### 범위별 차이

| 항목 | 프로젝트 | 사용자 |
|------|----------|--------|
| settings.json 위치 | `.claude/settings.json` | `~/.claude/settings.json` |
| hook 스크립트 위치 | `.claude/hooks/` | `~/.claude/hooks/` |
| PROJECT_DIR | 절대경로 bake-in | `${CLAUDE_PROJECT_DIR:-.}` (동적) |
| 팀 공유 | git commit으로 공유 가능 | 불가 (개인 설정) |
| 적용 범위 | 이 프로젝트만 | 모든 프로젝트 (git repo인 경우만 동작) |

## Step 5: Default Branch Guard 스크립트 생성

> **프로젝트 범위**: Step 1에서 감지한 기본 브랜치를 bake-in합니다. 변경 시 `/setup` 재실행.
> **사용자 범위**: 기본 브랜치를 비워두고 런타임에 프로젝트별로 감지합니다.

### 프로젝트 범위 선택 시

`git-utils guard`가 직접 guard 역할을 수행하므로 별도의 hook 스크립트 파일을 생성할 필요 없이, `git-utils guard` 명령을 hook으로 등록합니다.

```bash
PROJECT_DIR=$(pwd)
DEFAULT_BRANCH=$(git symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's|refs/remotes/origin/||' || echo 'main')
```

### 사용자 범위 선택 시

사용자 범위에서는 `--project-dir`을 동적으로 설정하고, 기본 브랜치를 런타임에 감지합니다.

## Step 6: settings.json에 Hook 등록

`git-utils hook register` CLI로 hook을 등록합니다.

### Write/Edit Guard 등록

#### 프로젝트 범위 선택 시

```bash
git-utils hook register PreToolUse "Write|Edit" \
  "git-utils guard write --project-dir=$PROJECT_DIR --create-branch-script='git-utils branch' --default-branch=$DEFAULT_BRANCH" \
  --timeout=5
```

#### 사용자 범위 선택 시

```bash
git-utils hook register PreToolUse "Write|Edit" \
  "git-utils guard write --project-dir=\${CLAUDE_PROJECT_DIR:-.} --create-branch-script='git-utils branch'" \
  --timeout=5 \
  --project-dir="$HOME"
```

### Bash Commit Guard 등록

#### 프로젝트 범위 선택 시

```bash
git-utils hook register PreToolUse "Bash" \
  "git-utils guard commit --project-dir=$PROJECT_DIR --create-branch-script='git-utils branch' --default-branch=$DEFAULT_BRANCH" \
  --timeout=5
```

#### 사용자 범위 선택 시

```bash
git-utils hook register PreToolUse "Bash" \
  "git-utils guard commit --project-dir=\${CLAUDE_PROJECT_DIR:-.} --create-branch-script='git-utils branch'" \
  --timeout=5 \
  --project-dir="$HOME"
```

`git-utils hook register`가 자동 처리하는 내용:
- settings.json 파일이 없으면 생성
- 기존 hook 배열에 새 hook 추가 (덮어쓰지 않음)
- 동일한 command가 이미 있으면 업데이트

## Step 7: 완료 메시지

### 프로젝트 범위

```
Default Branch Guard가 프로젝트에 설정되었습니다!

설정된 hook:
├─ PreToolUse (Write|Edit) → git-utils guard write
├─ PreToolUse (Bash) → git-utils guard commit
└─ .claude/settings.json (hook 등록됨)

Default Branch Guard:
├─ Write/Edit 시 기본 브랜치({default_branch}) 감지 → 즉시 브랜치 생성 제안
├─ git commit 시도 시 기본 브랜치 감지 → 즉시 브랜치 생성 제안
└─ rebase/merge/conflict/non-git 상태에서는 건너뜀

설정을 변경하려면 /hook-config를 실행하세요.

.claude/ 디렉토리를 git에 커밋하면 팀과 설정을 공유할 수 있습니다.
```

### 사용자 범위

```
Default Branch Guard가 사용자 설정에 등록되었습니다!

설정된 hook:
├─ PreToolUse (Write|Edit) → git-utils guard write
├─ PreToolUse (Bash) → git-utils guard commit
└─ ~/.claude/settings.json (hook 등록됨)

Default Branch Guard:
├─ Write/Edit 시 기본 브랜치 감지 → 즉시 브랜치 생성 제안
├─ git commit 시도 시 기본 브랜치 감지 → 즉시 브랜치 생성 제안
├─ git 저장소가 아닌 프로젝트에서는 자동 건너뜀
└─ rebase/merge/conflict 상태에서는 건너뜀

설정을 변경하려면 /hook-config를 실행하세요.
```

## 기존 설정 감지

이미 hook이 설치된 경우 `git-utils hook list`로 확인합니다:

```bash
git-utils hook list PreToolUse
git-utils hook list PreToolUse --project-dir="$HOME"
```

```
기존 hook이 발견되었습니다.
├─ Write/Edit Guard: {detected or "없음"}
└─ Commit Guard: {detected or "없음"}

옵션:
1. 덮어쓰기 - 최신 설정으로 재등록
2. 취소 - 기존 설정 유지
```

## 예시 실행 흐름

### git 저장소에서 프로젝트 범위 설정

```
프로젝트 환경을 분석 중...

감지된 환경:
├─ Git 저장소: 확인
└─ 기본 브랜치: main

어떤 기능을 설정하시겠습니까?
[GitHub 환경 설정] [Default Branch Guard] [모두 설정] [취소]

> 모두 설정 선택

hook 설치 범위를 선택하세요.
[프로젝트 (Recommended)] [사용자]

> 프로젝트 선택

Default Branch Guard가 프로젝트에 설정되었습니다!

설정된 hook:
├─ PreToolUse (Write|Edit) → git-utils guard write
├─ PreToolUse (Bash) → git-utils guard commit
└─ .claude/settings.json (hook 등록됨)

설정을 변경하려면 /hook-config를 실행하세요.
```

### git 저장소가 아닌 환경

```
프로젝트 환경을 분석 중...

이 디렉토리는 git 저장소가 아닙니다.
git-workflow hook은 git 저장소에서만 동작합니다.

먼저 git init을 실행하거나, git 저장소 디렉토리에서 다시 실행해주세요.
```
