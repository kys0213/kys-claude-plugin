---
description: 현재 레포를 자율 개발 모니터링 대상으로 등록합니다
allowed-tools: ["AskUserQuestion", "Bash"]
---

# 자율 개발 모니터링 설정 위자드 (/auto-setup)

> **이 플러그인은 반드시 User Scope로 설치**해야 합니다.
> 사용자가 모니터링하려는 레포 디렉토리에서 이 커맨드를 호출합니다.

## 실행 흐름

### Step 1: 레포 감지

현재 디렉토리의 git remote에서 레포 URL을 자동 감지합니다:

```bash
git remote get-url origin
```

감지된 URL을 사용자에게 확인합니다.

### Step 1.5: GitHub Enterprise 자동 감지

감지된 URL에서 호스트를 추출하여 GitHub Enterprise 여부를 자동 판별합니다.

**판별 로직 (순서대로):**

1. `github.com` → 일반 GitHub (추가 설정 불필요, 다음 단계로)
2. `github.com`이 아닌 호스트 → `gh auth status`로 인증된 호스트 목록을 조회하여 매칭:

```bash
gh auth status 2>&1
```

출력에서 인증된 호스트 목록을 파싱합니다 (예: `github.com`, `git.mycompany.com` 등).

- 레포 URL의 호스트가 인증된 호스트 목록에 **있으면** → GitHub Enterprise로 감지
- 인증된 호스트 목록에 **없으면** → AskUserQuestion으로 확인:

```
감지된 호스트 '{detected_host}'가 gh CLI에 인증되어 있지 않습니다.

이 호스트가 GitHub Enterprise입니까?
- 예 → gh auth login 안내 후 중단
- 아니오 (GitHub이 아닌 호스트) → gh_host 없이 진행
```

**Enterprise 감지 시:**

```
GitHub Enterprise가 감지되었습니다: {detected_host}

gh CLI 인증을 확인합니다...
```

```bash
gh auth status --hostname {detected_host} 2>&1
```

**인증 안 된 경우:**

```
GitHub Enterprise 인증이 필요합니다.
다음 명령어로 로그인해주세요:

  gh auth login --hostname {detected_host}

로그인 후 /auto-setup을 다시 실행하세요.
```

→ 설정을 중단합니다.

**인증 된 경우:**

감지된 호스트를 `gh_host`로 저장하여 Step 9의 config JSON에 포함합니다.
`~/.git-workflow-env` 파일이 없으면 함께 생성합니다:

```bash
if [ ! -f ~/.git-workflow-env ]; then
  cat > ~/.git-workflow-env << 'ENV'
# git-workflow 환경 설정
# Generated by /auto-setup
export GH_HOST="{detected_host}"
ENV
  chmod 600 ~/.git-workflow-env
fi
```

### Step 2: 의존성 검증 및 리뷰 플러그인 감지

#### 2-1. 플러그인 검증

다음 플러그인이 `kys-claude-plugin` 마켓플레이스에서 User Scope로 설치되어 있는지 확인하세요:

| 구분 | 플러그인 | 마켓플레이스 |
|------|---------|-------------|
| 필수 | `git-utils` | `kys-claude-plugin` |
| 권장 | `develop-workflow` | `kys-claude-plugin` |

미설치 시 안내:
- **필수** (`git-utils`) → 경고 + `/plugin install git-utils@kys-claude-plugin` — 설치 확인이 완료되지 않으면 다음 단계로 진행하지 마세요.
- **권장** (`develop-workflow`) → "`develop-workflow` 없이도 autodev의 내장 워크플로우로 동작합니다. 설계→리뷰→구현 파이프라인과 Multi-LLM 리뷰를 사용하려면 설치를 권장합니다: `/plugin install develop-workflow@kys-claude-plugin`"

**감지 결과를 변수로 보관** (Step 7에서 사용):
- `has_develop_workflow`: `develop-workflow` 플러그인 설치 여부 (bool)

#### 2-2. 리뷰 플러그인 자동 감지

설치된 리뷰 관련 플러그인을 자동으로 스캔합니다.
플러그인 캐시 디렉토리를 탐색하여 사용 가능한 리뷰 커맨드를 수집하세요:

```bash
# 설치된 플러그인 캐시에서 리뷰 관련 커맨드 탐색
ls ~/.claude/plugins/cache/*/commands/*.md 2>/dev/null
```

**감지 대상 플러그인 및 커맨드:**

| 플러그인 | 커맨드 | 기능 |
|---------|--------|------|
| `develop-workflow` | `/develop-workflow:multi-review` | multi-LLM PR 리뷰 |
| `develop-workflow` | `/develop-workflow:develop-auto` | multi-LLM 이슈 분석 |
| `external-llm` | `/external-llm:invoke-codex` | OpenAI Codex 호출 |
| `external-llm` | `/external-llm:invoke-gemini` | Google Gemini 호출 |

**감지 결과를 변수로 보관** (Step 7에서 사용):
- `detected_plugins`: 감지된 플러그인 이름 목록
- `has_external_llm`: `external-llm` 플러그인 설치 여부 (bool)
- `has_multi_review`: `develop-workflow`의 `multi-review` 커맨드 존재 여부 (bool)

**감지 결과에 따른 안내:**
- `develop-workflow` 미설치 + `external-llm` 미설치 → "외부 워크플로우 플러그인 없이 autodev 내장 워크플로우로 동작합니다. 설계→리뷰→구현 파이프라인이 필요하면 `develop-workflow` 설치를 권장합니다."
- `develop-workflow` 설치됨 + `external-llm` 미설치 → "`external-llm` 없이도 `/multi-review`는 Claude 단일 모델로 동작합니다. multi-LLM (Codex+Gemini) 분석이 필요하면 `external-llm` 설치를 권장합니다."
- `develop-workflow` 설치됨 + `external-llm` 설치됨 → "multi-LLM 리뷰가 가능합니다 (Claude + Codex + Gemini)."

### Step 3: CLI 설치 및 버전 확인

플러그인의 `ensure-binary.sh` 스크립트로 `autodev` CLI 바이너리의 설치 및 버전을 확인합니다.
이 스크립트는 `plugin.json` 버전과 설치된 바이너리 버전을 비교하여 신규 설치, 업데이트, 스킵을 자동으로 결정합니다.

```bash
bash ${CLAUDE_PLUGIN_ROOT}/scripts/ensure-binary.sh
```

- **바이너리 미설치** → 자동 빌드 + `~/.local/bin/autodev`에 설치
- **설치 버전 < 플러그인 버전** → 재빌드 + 설치
- **설치 버전 >= 플러그인 버전** → 스킵

실패 시:
- `cargo`가 없으면 [Rust 설치](https://rustup.rs/)를 안내하고 중단합니다.
- `~/.local/bin`이 `$PATH`에 포함되어 있지 않으면 Step 10(셸 환경 등록)에서 함께 등록될 것임을 안내합니다.

### Step 4: 감시 대상 설정

AskUserQuestion으로 질문:
- 감시 대상: Issues / Pull Requests / 둘 다

### Step 5: 스캔 주기

AskUserQuestion으로 질문:
- 1분 (빠른 반응)
- 5분 (권장)
- 15분 (저부하)
- 직접 입력

### Step 6: Consumer 처리량

AskUserQuestion으로 질문:
- Issue Consumer 동시 처리 수 (1~3)
- PR Consumer 동시 처리 수 (1~3)
- Merge Consumer 동시 처리 수 (1~2)

### Step 7: 워크플로우 선택

Step 2-1과 2-2에서 감지된 플러그인 목록을 기반으로 사용 가능한 워크플로우 선택지를 동적으로 구성합니다.

**선택지 구성 로직:**

**Case 1: `external-llm` + `develop-workflow` 모두 감지됨**

AskUserQuestion으로 질문:
- Issue 분석 워크플로우:
  - `/develop-workflow:develop-auto` — multi-LLM (Claude+Codex+Gemini) (권장)
  - `/develop-workflow:develop-auto` — Claude 단일 모델
- PR 리뷰 워크플로우:
  - `/develop-workflow:multi-review` — multi-LLM (Claude+Codex+Gemini) (권장)
  - `/develop-workflow:multi-review` — Claude 단일 모델

**Case 2: `develop-workflow`만 감지됨 (`external-llm` 없음)**

AskUserQuestion으로 질문:
- Issue 분석 워크플로우:
  - `/develop-workflow:develop-auto` — Claude 단일 모델 (권장)
- PR 리뷰 워크플로우:
  - `/develop-workflow:multi-review` — Claude 단일 모델 (권장)

> `external-llm` 미설치로 multi-LLM 옵션은 표시하지 않습니다.
> 사용자에게 "multi-LLM을 사용하려면 `/plugin install external-llm@kys-claude-plugin` 후 재설정하세요"를 안내합니다.

**Case 3: `develop-workflow` 미설치**

AskUserQuestion으로 질문:
- Issue 워크플로우:
  - 내장 분석+구현 — autodev 기본 에이전트가 이슈 분석 후 직접 구현 (권장)
  - 분석만 수행 — 이슈를 분석하고 리포트만 작성 (구현은 수동)
- PR 리뷰 워크플로우:
  - 내장 리뷰 — autodev 기본 에이전트가 코드 리뷰 수행 (권장)

> `develop-workflow` 미설치로 설계→리뷰→구현 파이프라인과 Multi-LLM 합의 기능은 사용할 수 없습니다.
> 사용자에게 "파이프라인 기반 워크플로우가 필요하면 `/plugin install develop-workflow@kys-claude-plugin` 후 `/auto-config`로 재설정하세요"를 안내합니다.

**선택 결과 매핑:**

| 선택 | config 반영 |
|------|------------|
| multi-LLM 이슈 분석 | `workflow.issue: "/develop-workflow:develop-auto"`, `develop.review.multi_llm: true` |
| 단일 모델 이슈 분석 | `workflow.issue: "/develop-workflow:develop-auto"`, `develop.review.multi_llm: false` |
| multi-LLM PR 리뷰 | `workflow.pr: "/develop-workflow:multi-review"`, `commands.code_review: "/multi-review"` |
| 단일 모델 PR 리뷰 | `workflow.pr: "/develop-workflow:multi-review"`, `commands.code_review: "/multi-review"`, `develop.review.multi_llm: false` |
| 내장 분석+구현 | `workflow.issue: "builtin:analyze-and-implement"` |
| 분석만 수행 | `workflow.issue: "builtin:analyze-only"` |
| 내장 리뷰 | `workflow.pr: "builtin:review"` |

### Step 8: 필터 설정

AskUserQuestion으로 질문:
- 전체 이슈/PR 감시
- 특정 라벨만 (라벨명 입력)
- 특정 작성자 제외 (기본: dependabot, renovate)

### Step 9: 등록

수집된 설정을 JSON으로 구성하여 CLI에 전달합니다.
JSON은 `WorkflowConfig` 구조에 맞게 구성합니다.
Step 1.5에서 Enterprise가 감지된 경우 `consumer.gh_host` 필드를, Step 7의 워크플로우 선택 결과를 `workflow`/`develop` 필드에 포함합니다:

```bash
# 일반 GitHub — 기본 설정으로 등록
autodev repo add <url> --config '{"consumer":{"scan_interval_secs":<step5>,"issue_concurrency":<step6_issue>,"pr_concurrency":<step6_pr>,"merge_concurrency":<step6_merge>,"scan_targets":[<step4>]},"workflow":{"issue":"<step7_issue>","pr":"<step7_pr>"},"develop":{"review":{"multi_llm":<step7_multi_llm>}}}'

# GitHub Enterprise — gh_host 포함
autodev repo add <url> --config '{"consumer":{"gh_host":"<detected_host>","scan_interval_secs":<step5>,"issue_concurrency":<step6_issue>,"pr_concurrency":<step6_pr>,"merge_concurrency":<step6_merge>,"scan_targets":[<step4>]},"workflow":{"issue":"<step7_issue>","pr":"<step7_pr>"},"develop":{"review":{"multi_llm":<step7_multi_llm>}}}'
```

등록 성공 시 CLI가 자동으로 워크스페이스 디렉토리(`~/.autodev/workspaces/<org-repo>/`)에 `.develop-workflow.yaml`을 생성합니다.

`--config` 없이 등록한 경우에도 이후 `autodev repo config <name>`으로 설정을 확인하고 수동 편집할 수 있습니다.

### Step 10: 셸 환경 등록

최초 설정 시 셸 프로필에 환경변수와 alias를 등록할지 확인:

```bash
# ~/.bashrc 또는 ~/.zshrc에 추가
export AUTODEV_HOME="$HOME/.autodev"
export PATH="$HOME/.local/bin:$PATH"

alias auto="autodev"
alias auto-s="autodev status"
alias auto-d="autodev dashboard"
alias auto-q="autodev queue list"
```

### Step 11: 설정 요약

최종 설정을 사용자에게 보기 좋게 출력합니다.
