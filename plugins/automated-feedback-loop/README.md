# Automated Feedback Loop Plugin

자동화된 피드백 루프를 통한 인간-에이전트 협업 시스템

## 핵심 철학

```
┌─────────────────────────────────────────────────────────────────────┐
│                    HUMAN-AGENT COLLABORATION                        │
│                                                                     │
│   ┌───────────────────┐         ┌───────────────────────────────┐  │
│   │   ARCHITECT LOOP  │         │    AUTONOMOUS DELEGATION      │  │
│   │   (인간 + 에이전트)│         │    (에이전트 자율 실행)        │  │
│   │                   │         │                               │  │
│   │  • 스펙 설계      │ ──────▶ │  • 구현                       │  │
│   │  • 아키텍처 결정  │         │  • 테스트                     │  │
│   │  • 기준점 정의    │ ◀────── │  • 검증                       │  │
│   │                   │  피드백  │                               │  │
│   └───────────────────┘         └───────────────────────────────┘  │
│                                                                     │
│   사람이 집중: "무엇을" + "왜"     에이전트가 집중: "어떻게"        │
└─────────────────────────────────────────────────────────────────────┘
```

## 핵심 개념

### 1. Checkpoint (기준점)

구현과 테스트의 **성공/실패 기준**을 명확히 정의합니다.

```yaml
checkpoints:
  - name: "쿠폰 적용 API"
    type: "api"
    criteria:
      - "POST /coupons/apply 가 200 응답"
      - "중복 적용 시 409 응답"
      - "만료된 쿠폰은 400 응답"
    validation:
      command: "npm run test:e2e -- --grep 'coupon'"
      expectedOutput: "3 passing"
```

### 2. Architect Loop (설계 루프)

인간이 에이전트와 **대화형으로** 설계를 정제합니다.

```
인간: "쿠폰 시스템 만들어줘"
    │
    ▼
┌─────────────────────────────────────────┐
│  에이전트: 스펙 초안 제안               │
│  • 도메인 모델 제안                     │
│  • 아키텍처 옵션 제시                   │
│  • 트레이드오프 분석                    │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│  인간: 검토 및 피드백                   │
│  • "쿠폰 중복 적용은 안돼"              │
│  • "만료일 기준은 UTC로"                │
│  • 아키텍처 결정                        │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│  에이전트: 피드백 반영 및 재제안        │
│  • 수정된 스펙                          │
│  • 검증 기준점 (Checkpoint) 제안        │
└─────────────────────────────────────────┘
    │
    ▼ (인간 승인 시)

Checkpoint 확정 → 구현 위임 가능
```

### 3. Delegation (위임)

확정된 Checkpoint를 기준으로 **자율 에이전트가 구현**합니다.

```
┌─────────────────────────────────────────────────────────────────┐
│                    AUTONOMOUS EXECUTION                          │
│                                                                  │
│   Checkpoint 기반 구현                                           │
│   ┌──────────┐     ┌──────────┐     ┌──────────┐               │
│   │   구현   │────▶│  자동    │────▶│  통과?   │               │
│   │  에이전트 │     │  검증    │     │          │               │
│   └──────────┘     └──────────┘     └────┬─────┘               │
│                                          │                       │
│                     ┌────────────────────┴────────────────┐     │
│                     │                                     │     │
│                     ▼ NO                                  ▼ YES │
│              ┌──────────────┐                     ┌────────────┐│
│              │ 자동 피드백   │                     │  완료 보고 ││
│              │ + 재시도     │                     │  (인간에게) ││
│              └──────┬───────┘                     └────────────┘│
│                     │                                            │
│                     └──────▶ 최대 N회 반복                       │
│                                                                  │
│   실패 시: 인간에게 에스컬레이션 (설계 문제 가능성)              │
└─────────────────────────────────────────────────────────────────┘
```

## 명령어

### `/afl:architect` - 설계 루프

인간과 에이전트가 협업하여 스펙/아키텍처를 설계합니다.

```bash
# 새 설계 시작
/afl:architect "결제 시스템에 쿠폰 기능 추가"

# 기존 설계 재개
/afl:architect --resume <session-id>
```

**출력 산출물:**
- `specs/architecture.md` - 아키텍처 설계
- `specs/contracts.md` - 인터페이스 정의
- `specs/checkpoints.yaml` - 검증 기준점

### `/afl:delegate` - 구현 위임

확정된 스펙을 자율 에이전트에게 위임합니다.

```bash
# 특정 체크포인트 구현 위임
/afl:delegate checkpoint-coupon-api

# 전체 구현 위임 (병렬)
/afl:delegate --all
```

**자동 실행 흐름:**
1. 에이전트가 구현 시작
2. Checkpoint 기준으로 자동 검증
3. 실패 시 자동 피드백 + 재시도
4. 성공/최종실패 시 인간에게 보고

### `/afl:checkpoint` - 기준점 관리

```bash
# 체크포인트 목록
/afl:checkpoint --list

# 특정 체크포인트 검증
/afl:checkpoint validate coupon-api

# 체크포인트 추가
/afl:checkpoint add "새 기준점 설명"
```

### `/afl:loop-status` - 피드백 루프 상태

```bash
/afl:loop-status

# 출력 예시:
# 🔄 Active Feedback Loops
#
# checkpoint-coupon-api
#   Status: iteration 2/5
#   Last: ❌ Test failed: "중복 적용 시 409 응답"
#   Action: Auto-retry in progress
#
# checkpoint-admin-ui
#   Status: ✅ Completed
#   Result: All 5 checkpoints passed
```

## 워크플로우

```
┌─────────────────────────────────────────────────────────────────────┐
│                     FULL WORKFLOW                                    │
│                                                                      │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │  PHASE 1: ARCHITECT LOOP (인간 + 에이전트)                  │    │
│  │                                                             │    │
│  │  /afl:architect "요구사항"                                  │    │
│  │      │                                                      │    │
│  │      ▼                                                      │    │
│  │  ┌──────────┐    ┌──────────┐    ┌──────────┐              │    │
│  │  │ 스펙 초안 │───▶│ 인간검토 │───▶│ 피드백   │              │    │
│  │  └──────────┘    └──────────┘    └────┬─────┘              │    │
│  │       ▲                               │                     │    │
│  │       └───────────────────────────────┘                     │    │
│  │                    (반복)                                   │    │
│  │                       │                                     │    │
│  │                       ▼ (승인 시)                           │    │
│  │              ┌────────────────┐                             │    │
│  │              │ Checkpoints    │                             │    │
│  │              │ 확정           │                             │    │
│  │              └────────────────┘                             │    │
│  └─────────────────────────────────────────────────────────────┘    │
│                          │                                           │
│                          ▼                                           │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │  PHASE 2: AUTONOMOUS DELEGATION (에이전트 자율)             │    │
│  │                                                             │    │
│  │  /afl:delegate --all                                        │    │
│  │      │                                                      │    │
│  │      ▼                                                      │    │
│  │  ┌──────────────────────────────────────────────────────┐  │    │
│  │  │  Checkpoint 1: coupon-api                            │  │    │
│  │  │  ┌────────┐   ┌────────┐   ┌────────┐               │  │    │
│  │  │  │ 구현   │──▶│ 검증   │──▶│ 통과?  │               │  │    │
│  │  │  └────────┘   └────────┘   └───┬────┘               │  │    │
│  │  │                                │                     │  │    │
│  │  │                    ┌───────────┴───────────┐        │  │    │
│  │  │                    ▼ NO                    ▼ YES    │  │    │
│  │  │              ┌──────────┐           ┌──────────┐   │  │    │
│  │  │              │자동피드백│           │ 다음     │   │  │    │
│  │  │              │+ 재시도  │           │Checkpoint│   │  │    │
│  │  │              └──────────┘           └──────────┘   │  │    │
│  │  └──────────────────────────────────────────────────────┘  │    │
│  │                                                             │    │
│  │  최대 N회 실패 → 인간에게 에스컬레이션                      │    │
│  └─────────────────────────────────────────────────────────────┘    │
│                          │                                           │
│                          ▼                                           │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │  PHASE 3: COMPLETION (결과 보고)                            │    │
│  │                                                             │    │
│  │  • 모든 Checkpoint 통과 → 완료 보고                        │    │
│  │  • 일부 실패 → 실패 분석 + 설계 재검토 제안                │    │
│  │  • /afl:architect --resume 로 설계 루프 재진입 가능        │    │
│  └─────────────────────────────────────────────────────────────┘    │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

## 기존 team-claude와의 차이점

| 측면 | team-claude | automated-feedback-loop |
|------|-------------|-------------------------|
| 설계 단계 | 단방향 (제안 → 승인) | **양방향 대화형 루프** |
| 구현 검증 | 수동 리뷰 요청 | **자동 Checkpoint 검증** |
| 실패 처리 | 수동 피드백 | **자동 피드백 + 재시도** |
| 인간 개입 | 매 단계 | **설계만 + 에스컬레이션 시** |
| 기준점 | 암묵적 | **명시적 Checkpoint** |

## 설정

```json
{
  "autoFeedbackLoop": {
    "enabled": true,
    "maxIterations": 5,
    "checkpointValidation": true,
    "autoRouteOnComplete": true
  },
  "architectLoop": {
    "requireHumanApproval": ["architecture", "contracts", "checkpoints"],
    "autoProgress": ["implementation", "test"]
  },
  "delegation": {
    "autoValidateOnComplete": true,
    "autoRetryOnFail": true,
    "maxRetries": 3
  }
}
```

## 사용 시나리오

### 시나리오 1: 새 기능 개발

```bash
# 1. 설계 루프 시작
/afl:architect "사용자 알림 시스템 개발"

# 2. 대화를 통해 스펙 정제
#    - 에이전트: "푸시 알림과 이메일 중 어떤 것을 우선할까요?"
#    - 인간: "푸시 우선, 이메일은 폴백"
#    - 에이전트: "재시도 로직은 어떻게 할까요?"
#    - 인간: "3회 재시도, 지수 백오프"

# 3. Checkpoint 승인 후 위임
/afl:delegate --all

# 4. 자동 실행 모니터링
/afl:loop-status
```

### 시나리오 2: 실패 후 설계 재검토

```bash
# 구현이 3회 실패 후 에스컬레이션
#
# ⚠️ Checkpoint 실패: notification-retry
#
# 실패 원인 분석:
#   - 테스트: "지수 백오프 3회 재시도"
#   - 실패: 타임아웃 발생
#   - 추정: 백오프 간격이 너무 길거나 외부 서비스 문제
#
# 제안:
#   1. 백오프 간격 조정 (설계 변경)
#   2. 테스트 타임아웃 증가 (테스트 변경)
#   3. 모킹으로 대체 (테스트 방식 변경)

# 설계 루프로 재진입
/afl:architect --resume <session-id>
```

## 파일 구조

```
.afl/
├── sessions/
│   └── {session-id}/
│       ├── meta.json           # 세션 메타정보
│       ├── conversation.md     # 설계 대화 기록
│       ├── specs/
│       │   ├── architecture.md
│       │   ├── contracts.md
│       │   └── checkpoints.yaml
│       └── delegations/
│           └── {checkpoint-id}/
│               ├── status.json
│               ├── iterations/
│               │   ├── 1/
│               │   │   ├── result.json
│               │   │   └── feedback.md
│               │   └── 2/
│               │       └── ...
│               └── final-result.json
```

## 컨텍스트 엔지니어링 원칙

| 원칙 | 구현 |
|------|------|
| **사람은 "무엇을"과 "왜"에 집중** | Architect Loop에서 스펙/기준 정의 |
| **에이전트는 "어떻게"에 집중** | Delegation에서 자율 구현 |
| **기준점으로 모호성 제거** | Checkpoint로 성공/실패 명확히 정의 |
| **실패는 학습 기회** | 자동 분석 + 설계 재검토 유도 |
| **불필요한 개입 최소화** | 구현은 자동, 설계만 인간 참여 |
